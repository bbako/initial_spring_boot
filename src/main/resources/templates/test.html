<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>

<div>
  상위
  <select id="cate_1" class="select" name="cate_1">
    <option value="">--선택--</option>
    <option th:each="ctgr : ${ctgr_list}" th:value="${ctgr.ctgrId}" th:text="${ctgr.ctgrName}"></option>
  </select>
</div>
<div>
  하위
<select  id="category">
  <!--<option value="10">cate10</option>
  <option value="20">cate20</option>
  <option value="30">cate30</option>-->
</select>
</div>
<div>
  이름
  <input type="text" name="prdct_name" id="prdct_name">
</div>
<div>
  설명
  <input type="text" name="prdct_info" id="prdct_info">
</div>
<div>
<input id="m_file" name="uploadFiles" type="file">
</div>
  <button id="regi_prdct" class="uploadBtn">등록</button>

<div class="uploadResult">

</div>

<div>
  <table>
    <colgroup>
      <col width="10%">
      <col width="10%">
      <col width="20%">
      <col width="30%">
      <col width="10%">
    </colgroup>
    <thead>
      <tr>
        <th>category</th>
        <th>name</th>
        <th>info</th>
        <th>img</th>
        <th>del</th>
      </tr>
    </thead>
    <tbody id="pro_list">
    </tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script>

  getlist();

  var a = "";

  $("#m_file").change(function(e){

    var formData = new FormData();

    var inputFile = $("input[type='file']");

    var files = inputFile[0].files;

    for (var i = 0; i < files.length; i++) {
      formData.append("uploadFiles", files[i]);
    }

    $.ajax({
      url: '/uploadAjax',
      processData: false,
      contentType: false,
      data: formData,
      type: 'POST',
      dataType:'json',
      success: function(result){
        a = showUploadedImages(result);
      },
      error: function(jqXHR, textStatus, errorThrown){
        console.log(textStatus);
      }

    });

  });

  function showUploadedImages(arr){

    var divArea = $(".uploadResult");

    var str = "";

    for(var i = 0; i < arr.length; i++){
      str += "<div>";
      str += "<img src='/display?fileName="+arr[i].imageURL+"' width='150px'>";
      str += "<button class='removeBtn' data-name='"+arr[i].imageURL +"'>REMOVE</button>"
      str += "</div>";
    }
    divArea.append(str);

    return arr[0].imageURL;

  }

  $(".uploadResult").on("click", ".removeBtn", function(e){

    var target = $(this);
    var fileName = target.data("name");
    var targetDiv = $(this).closest("div");

    $.post('/removeFile', {fileName: fileName}, function(result){
      if(result === true){
        targetDiv.remove();
      }
    } )

  });

  $("#regi_prdct").on("click", function(e){

    var formData = new FormData();
    var ctgr_id = $("#category option:selected").val();
    var prdct_name = $("#prdct_name").val();
    var prdct_info = $("#prdct_info").val();

    formData.append("prdctImg", a);
    formData.append("ctgrId", ctgr_id);
    formData.append("prdctName", prdct_name);
    formData.append("prdctInfo", prdct_info);

    $.ajax({
      url: '/addProduct',
      processData: false,
      contentType: false,
      data: formData,
      type: 'POST',
      dataType: 'text',
      success: function(result){
        getlist();
      }
    })

  });

  function getlist(){

    $.ajax({
      url: '/getProduct',
      processData: false,
      contentType: false,
      data: {},
      type: 'POST',
      dataType:'json',
      success: function(result){
        $("#pro_list").empty();

        var str = "";

        for(var i = 0 ; i < result.length ; i++ ){
          str +='<tr>' +
                '  <td>'+ result[i].upperCtgrName+' > '+ result[i].ctgrName +'</td>' +
                '  <td>'+ result[i].prdctName +'</td>' +
                '  <td>'+ result[i].prdctInfo +'</td>' +
                '  <td><img src="/display?fileName='+result[i].prdctImg+'" width="150px"></td>' +
                '  <td><button onclick="delProduct(\''+ result[i].prdctId +'\')">del</button></td>' +
                '</tr>';
        }
        $("#pro_list").append(str);
      },
      error: function(jqXHR, textStatus, errorThrown){
        console.log(textStatus);
      }

    });
  }

  function delProduct(prdctId){
    var formData = new FormData();
    formData.append("prdctId", prdctId);
    $.ajax({
      url: '/delProduct',
      processData: false,
      contentType: false,
      data: formData,
      type: 'POST',
      dataType:'text',
      success: function(result){
        getlist();
      },
      error: function(jqXHR, textStatus, errorThrown){
        console.log(textStatus);
      }

    });
  }


  $('#cate_1').on('change', function() {
    var formData = new FormData();
    formData.append("ctgrId", this.value);
    $.ajax({
      url: '/getCategory2',
      processData: false,
      contentType: false,
      data: formData,
      type: 'POST',
      dataType:'json',
      success: function(result){
        console.log(result);
        $("#category").empty();

        var str = "";
        for(var i = 0 ; i < result.length ; i++ ){
          str += '<option value="'+ result[i].ctgrId +'">'+ result[i].ctgrName +'</option>';
        }

        $("#category").append(str);
      },
      error: function(jqXHR, textStatus, errorThrown){
        console.log(textStatus);
      }
    });
  });

</script>
</body>
</html>
